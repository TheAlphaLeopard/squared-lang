<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>sqrd (^2) IDE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --bg: #0d0d0d; --bg-ui: #161616; --accent: #FFB74D; --text: #d1d1d1; --border: #222; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        .toolbar { height: 40px; background: var(--bg-ui); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 10px; justify-content: space-between; }
        .toolbar-group { display: flex; gap: 8px; align-items: center; }
        
        .btn { background: #222; color: #999; border: 1px solid #333; height: 28px; padding: 0 10px; border-radius: 4px; cursor: pointer; font-size: 11px; display: flex; align-items: center; justify-content: center; transition: 0.2s; text-transform: uppercase; letter-spacing: 0.5px; }
        .btn:hover { background: #333; color: #fff; }
        .btn-accent { background: var(--accent); color: #000; border: none; font-weight: bold; }
        .btn-accent:hover { background: #ffa726; color: #000; }

        .main-layout { flex: 1; display: grid; grid-template-columns: 1fr 1fr; overflow: hidden; }
        .editor-pane { display: flex; flex-direction: column; border-right: 1px solid var(--border); }
        .right-pane { display: grid; grid-template-rows: 1fr 1fr; }
        
        .tabs { display: flex; background: #111; height: 32px; border-bottom: 1px solid var(--border); overflow-x: auto; scrollbar-width: none; }
        .tab { padding: 0 15px; height: 100%; display: flex; align-items: center; font-size: 11px; cursor: pointer; border-right: 1px solid var(--border); background: #111; color: #666; position: relative; border-bottom: 2px solid transparent; }
        .tab.active { background: var(--bg); color: var(--accent); border-bottom: 2px solid var(--accent); }
        .tab span.close-btn { font-size: 10px; margin-left: 10px; color: #444; padding: 2px 5px; }
        .tab span.close-btn:hover { color: #f44; }
        
        #code-editor { flex: 1; padding: 15px; font-family: 'Consolas', 'Monaco', monospace; font-size: 13px; outline: none; white-space: pre; overflow: auto; background: var(--bg); color: #dcdcaa; tab-size: 4; line-height: 1.5; }
        .canvas-container { background: #000; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; border-bottom: 1px solid var(--border); }
        #sgl-canvas { max-width: 100%; max-height: 100%; }
        .console-container { background: #050505; padding: 10px; font-family: 'Consolas', monospace; font-size: 12px; overflow-y: auto; color: #eee; position: relative; }
        .log-error { color: #ff5252; }
        
        #input-container { position: absolute; bottom: 0; left: 0; right: 0; background: #000; padding: 5px; border-top: 1px solid #333; display: none; }
        #input-field { width: 100%; background: #111; border: 1px solid #222; color: #fff; padding: 5px; font-size: 12px; outline: none; }
        
        .token-comment { color: #6A9955; }
        .token-keyword { color: #FFB74D; } 
        .token-number { color: #CE9178; }
        .token-string { color: #CE9178; }
        .token-type { color: #4FC3F7; }
    </style>
</head>
<body>
    <div class="toolbar">
        <div class="toolbar-group">
            <button class="btn" id="btn-import" title="Import File">IMPORT</button>
            <button class="btn" id="btn-export" title="Export File">EXPORT</button>
            <button class="btn" id="btn-module" title="Add Module">MODULE</button>
        </div>
        <div class="toolbar-group">
            <button class="btn btn-accent" id="btn-run">RUN</button>
            <button class="btn" id="btn-stop">STOP</button>
            <button class="btn" id="btn-clear">CLEAR</button>
        </div>
    </div>
    <div class="main-layout">
        <div class="editor-pane">
            <div class="tabs" id="tab-list"></div>
            <pre id="code-editor" contenteditable="plaintext-only" spellcheck="false"></pre>
        </div>
        <div class="right-pane">
            <div class="canvas-container" id="canvas-area">
                <div style="color: #333; font-size: 12px; font-style: italic;">Canvas Output (Unused)</div>
            </div>
            <div class="console-container" id="console-output"></div>
        </div>
    </div>
    <div id="input-container"><input type="text" id="input-field" placeholder="Input required..."></div>

    <input type="file" id="file-in" style="display:none">
    <input type="file" id="mod-in" style="display:none">

    <script type="module">
        import { Lexer, Parser } from 'https://cdn.jsdelivr.net/gh/TheAlphaLeopard/squared-lang@main/src/parser.js';
        import { Interpreter } from 'https://cdn.jsdelivr.net/gh/TheAlphaLeopard/squared-lang@main/src/interpreter.js';

        const editor = document.getElementById('code-editor');
        const consoleOut = document.getElementById('console-output');
        const tabList = document.getElementById('tab-list');
        const inpCont = document.getElementById('input-container');
        const inpField = document.getElementById('input-field');

        let files = [
            { name: 'main.sq', content: '' },
            { name: 'random.sq', content: '' }
        ];
        let activeIdx = 0;
        let interpreter = null;
        const projectScope = new Map();
        window.__sqrdModules = new Map();

        const rules = [
            { r: /(--.*)/g, c: 'token-comment' },
            { r: /\b(function|return|if|else|while|for|break|continue|import|eval|True|False)\b/g, c: 'token-keyword' },
            { r: /(!-?\d+!)/g, c: 'token-number' },
            { r: /("[^"]*")/g, c: 'token-string' },
            { r: /(#[a-zA-Z_][a-zA-Z0-9_]*#)/g, c: 'token-type' }
        ];

        function highlight() {
            const pos = getCaret(editor);
            let html = editor.innerText.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            const combined = new RegExp(rules.map(x => `(${x.r.source})`).join('|'), 'g');
            editor.innerHTML = html.replace(combined, (m, ...args) => {
                const i = args.findIndex((v, idx) => idx < rules.length && v !== undefined);
                return i !== -1 ? `<span class="${rules[i].c}">${m}</span>` : m;
            });
            setCaret(editor, pos);
            files[activeIdx].content = editor.innerText;
        }

        function getCaret(el) {
            const sel = window.getSelection();
            if (!sel.rangeCount) return 0;
            const range = sel.getRangeAt(0);
            const pre = range.cloneRange();
            pre.selectNodeContents(el);
            pre.setEnd(range.endContainer, range.endOffset);
            return pre.toString().length;
        }

        function setCaret(el, pos) {
            const sel = window.getSelection();
            const range = document.createRange();
            let cur = 0;
            const stack = [el];
            while (stack.length > 0) {
                const node = stack.pop();
                if (node.nodeType === 3) {
                    if (cur + node.length >= pos) {
                        range.setStart(node, pos - cur);
                        range.collapse(true);
                        sel.removeAllRanges();
                        sel.addRange(range);
                        return;
                    }
                    cur += node.length;
                } else {
                    for (let i = node.childNodes.length - 1; i >= 0; i--) stack.push(node.childNodes[i]);
                }
            }
        }

        function renderTabs() {
            tabList.innerHTML = '';
            files.forEach((f, i) => {
                const tab = document.createElement('div');
                tab.className = `tab ${i === activeIdx ? 'active' : ''}`;
                const nameSpan = document.createElement('span');
                nameSpan.textContent = f.name;
                tab.appendChild(nameSpan);
                
                if (files.length > 1) {
                    const closeBtn = document.createElement('span');
                    closeBtn.className = 'close-btn';
                    closeBtn.textContent = 'âœ•';
                    closeBtn.onclick = (e) => {
                        e.stopPropagation();
                        files.splice(i, 1);
                        activeIdx = Math.min(activeIdx, files.length - 1);
                        loadActive();
                    };
                    tab.appendChild(closeBtn);
                }
                
                tab.onclick = () => {
                    activeIdx = i;
                    loadActive();
                };
                tabList.appendChild(tab);
            });
            const add = document.createElement('div');
            add.className = 'tab';
            add.textContent = '+';
            add.onclick = () => {
                files.push({ name: `file${files.length}.sq`, content: '' });
                activeIdx = files.length - 1;
                loadActive();
            };
            tabList.appendChild(add);
        }

        function loadActive() {
            editor.innerText = files[activeIdx].content;
            highlight();
            renderTabs();
        }

        function log(m, err = false) {
            const d = document.createElement('div');
            d.className = err ? 'log-error' : '';
            d.textContent = `> ${m}`;
            consoleOut.appendChild(d);
            consoleOut.scrollTop = consoleOut.scrollHeight;
        }

        editor.oninput = highlight;
        editor.onkeydown = (e) => {
            if (e.key === 'Tab') {
                e.preventDefault();
                const pos = getCaret(editor);
                editor.innerText = editor.innerText.slice(0, pos) + '    ' + editor.innerText.slice(pos);
                highlight();
                setCaret(editor, pos + 4);
            }
        };

        document.getElementById('btn-run').onclick = async () => {
            consoleOut.innerHTML = '';
            log(`Running ${files[activeIdx].name}...`);
            try {
                const tokens = new Lexer(editor.innerText).tokenize();
                const ast = new Parser(tokens).parse();
                
                if (!interpreter) {
                    interpreter = new Interpreter(log, (m) => {
                        log(m);
                        inpCont.style.display = 'block';
                        inpField.value = '';
                        inpField.focus();
                        return new Promise(r => {
                            const h = (ev) => { if(ev.key==='Enter'){ inpCont.style.display='none'; inpField.removeEventListener('keydown', h); r(inpField.value); } };
                            inpField.addEventListener('keydown', h);
                        });
                    }, projectScope);
                }
                
                await interpreter.run(ast);
                log('Done.');
            } catch (e) { log(e.message, true); }
        };

        document.getElementById('btn-stop').onclick = () => { if(interpreter) interpreter.stop = true; log('Stopped.'); };
        document.getElementById('btn-clear').onclick = () => consoleOut.innerHTML = '';
        document.getElementById('btn-import').onclick = () => document.getElementById('file-in').click();
        document.getElementById('btn-module').onclick = () => document.getElementById('mod-in').click();
        document.getElementById('btn-export').onclick = () => {
            const b = new Blob([editor.innerText], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(b);
            a.download = files[activeIdx].name;
            a.click();
        };

        document.getElementById('file-in').onchange = (e) => {
            const f = e.target.files[0]; if (!f) return;
            const r = new FileReader();
            r.onload = (ev) => { files.push({ name: f.name, content: ev.target.result }); activeIdx = files.length - 1; loadActive(); };
            r.readAsText(f);
        };

        document.getElementById('mod-in').onchange = (e) => {
            const f = e.target.files[0]; if (!f) return;
            const r = new FileReader();
            r.onload = async (ev) => {
                const b = new Blob([ev.target.result], { type: 'application/javascript' });
                window.__sqrdModules.set(f.name, URL.createObjectURL(b));
                log(`Module ${f.name} loaded.`);
            };
            r.readAsText(f);
        };

        (async () => {
            try {
                const res1 = await fetch('example.sq');
                if (res1.ok) files[0].content = await res1.text();
                
                const res2 = await fetch('random.sq');
                if (res2.ok) files[1].content = await res2.text();
            } catch {}
            loadActive();
        })();
    </script>
</body>
</html>
